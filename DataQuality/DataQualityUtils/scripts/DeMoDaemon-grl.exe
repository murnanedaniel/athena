#!/bin/bash
# Copyright (C) 2002-2022 CERN for the benefit of the ATLAS collaboration
# Author : Benjamin Trocme (CNRS/IN2P3 - LPSC Grenoble) - 2017 - 2022
#
# Script derived from DemoDaemon.exe without update of the run list and 
# production of weekly reports.
# Mainly meant to be used for the update of the year stats for GRL runs. 
# As the GRL runs are updated only every 1-2 weeks, no cron job defined. 
# The user has to run it interactively in an atlasdqm lxplus console.
# 
# Arguments:
# -$1 : directory when to run the daemon (a priori ~atlasdqm/w1/DeMo)
# -$2 : DeMo year
# -$3 : DeMo tag (a priori GRL_[year])
##################################################################

rundir=$1
year=$2
tag=$3

date=`date`
echo "Date is ${date}"
cd ${rundir}
echo "Now in ${rundir}"
export AtlasSetup=/afs/cern.ch/atlas/software/dist/AtlasSetup
source $AtlasSetup/scripts/asetup.sh Athena,22.0.81

systems='LAr Pixel SCT TRT Tile MDT TGC RPC Trig_L1 Trig_HLT Lumi Global ALFA LUCID ZDC IDGlobal BTag CaloCP MuonCP '

for system in $systems
do
    echo "====================================================================================="
    echo "====================================================================================="
    echo "Processing "${system}
    echo "====================================================================================="
    echo "====================================================================================="
    

    # Script for updating the year stats
    # If you want to reset the year stats, use the first command line with --resetYearStats (not recommanded as much longer)
    #cmd="python DeMoUpdate.py -b -y ${year} -t ${tag} -s ${system} --resetYearStats --updateYearStats"
    cmd="python DeMoUpdate.py -b -y ${year} -t ${tag} -s ${system} --skipAlreadyUpdated --updateYearStats"
    log="YearStats-${system}/${year}/${tag}/daemon-grl.out"
    echo "** ${cmd} **"
    eval "rm -f ${log}"
    eval "${cmd} &> ${log}"

    # Display of the year stats plots
    cmd="python DeMoStatus.py -b -s ${system} -y ${year} -t ${tag} --yearStats --savePlots"
    log="YearStats-${system}/${year}/${tag}/daemon-YSplots.out"
    echo "** ${cmd} **"
    eval "rm -f ${log}"
    eval "${cmd} &> ${log}"

    # Producing the defect recap
    cmd="python DeMoScan.py -b -y ${year} -t ${tag} -s ${system} --recapDefects"
    log="YearStats-${system}/${year}/${tag}/daemon-recapDefects.out"
    echo "** ${cmd} **"
    eval "rm -f ${log}"
    eval "${cmd} &> ${log}"
    
done

eval ${cmd}
cmd="python /afs/cern.ch/user/a/atlasdqm/w1/DeMo/DeMoGenerateWWW.py"
eval ${cmd}
